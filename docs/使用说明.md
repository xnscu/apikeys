# API Keys åŠ¨æ€SQLç”Ÿæˆå™¨ä½¿ç”¨è¯´æ˜

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

è¿™ä¸ªè„šæœ¬ä¼š**åŠ¨æ€è¯»å–** `apikeys.txt` æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œç„¶åç”Ÿæˆå¯¹åº”çš„SQLæ–‡ä»¶ï¼Œæœ€åä½¿ç”¨wranglerå‘½ä»¤æ’å…¥åˆ°Cloudflare D1æ•°æ®åº“ã€‚

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€ç”¨æ³•
```bash
# ä½¿ç”¨é»˜è®¤è®¾ç½®ï¼ˆè¯»å–apikeys.txtï¼Œæ•°æ®åº“åapikeys-poolï¼‰
python generate_sql.py

# æŒ‡å®šè¾“å…¥æ–‡ä»¶
python generate_sql.py my_apikeys.txt

# æŒ‡å®šè¾“å…¥æ–‡ä»¶å’Œæ•°æ®åº“å
python generate_sql.py apikeys.txt my-database

# è‡ªåŠ¨æ‰§è¡Œwranglerå‘½ä»¤ï¼ˆç”ŸæˆSQLåç›´æ¥å¯¼å…¥æ•°æ®åº“ï¼‰
python generate_sql.py apikeys.txt apikeys-pool true
```

### å‚æ•°è¯´æ˜
1. **è¾“å…¥æ–‡ä»¶** (é»˜è®¤: `apikeys.txt`) - åŒ…å«APIå¯†é’¥çš„æ–‡æœ¬æ–‡ä»¶
2. **æ•°æ®åº“å** (é»˜è®¤: `apikeys-pool`) - Cloudflare D1æ•°æ®åº“åç§°
3. **è‡ªåŠ¨æ‰§è¡Œ** (é»˜è®¤: `false`) - æ˜¯å¦è‡ªåŠ¨æ‰§è¡Œwranglerå‘½ä»¤

## ğŸ“ è¾“å…¥æ–‡ä»¶æ ¼å¼

`apikeys.txt` æ–‡ä»¶æ ¼å¼ï¼šæ¯è¡Œä¸€æ¡è®°å½•ï¼Œæ ¼å¼ä¸º `email:api_key`

```
# è¿™æ˜¯æ³¨é‡Šè¡Œï¼Œä¼šè¢«å¿½ç•¥
user1@example.com:sk-1234567890abcdef
user2@gmail.com:sk-abcdef1234567890

# ç©ºè¡Œä¹Ÿä¼šè¢«å¿½ç•¥
admin@company.com:sk-fedcba0987654321
```

## ğŸ“„ ç”Ÿæˆçš„æ–‡ä»¶

è„šæœ¬ä¼šè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰ï¼š

1. **`schema_YYYYMMDD_HHMMSS.sql`** - æ•°æ®åº“è¡¨ç»“æ„
2. **`insert_apikeys_YYYYMMDD_HHMMSS.sql`** - æ’å…¥æ•°æ®çš„SQLï¼ˆæ¨èï¼‰
3. **`upsert_apikeys_YYYYMMDD_HHMMSS.sql`** - ç°ä»£åŒ–UPSERTè¯­æ³•
4. **`wrangler_commands_YYYYMMDD_HHMMSS.txt`** - wranglerå‘½ä»¤è¯´æ˜

## ğŸ”§ æ‰‹åŠ¨æ‰§è¡Œwranglerå‘½ä»¤

```bash
# 1. åˆ›å»ºè¡¨ç»“æ„
wrangler d1 execute apikeys-pool --file=schema_20250924_122649.sql

# 2. æ’å…¥æ•°æ®
wrangler d1 execute apikeys-pool --file=insert_apikeys_20250924_122649.sql

# 3. éªŒè¯æ•°æ®
wrangler d1 execute apikeys-pool --command="SELECT COUNT(*) as total FROM api_keys;"
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1: é¦–æ¬¡å¯¼å…¥æ•°æ®
```bash
python generate_sql.py
# ç„¶åæ‰‹åŠ¨æ‰§è¡Œç”Ÿæˆçš„wranglerå‘½ä»¤
```

### åœºæ™¯2: è‡ªåŠ¨åŒ–å¯¼å…¥
```bash
python generate_sql.py apikeys.txt apikeys-pool true
# è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰wranglerå‘½ä»¤
```

### åœºæ™¯3: ä¸åŒçš„æ•°æ®åº“
```bash
python generate_sql.py production_keys.txt prod-apikeys-db
```

### åœºæ™¯4: æµ‹è¯•ç¯å¢ƒ
```bash
python generate_sql.py test_keys.txt test-db true
```

## ğŸ”„ æ•°æ®æ›´æ–°æµç¨‹

1. **ç¼–è¾‘** `apikeys.txt` æ–‡ä»¶ï¼Œæ·»åŠ æˆ–ä¿®æ”¹APIå¯†é’¥
2. **è¿è¡Œè„šæœ¬** `python generate_sql.py`
3. **æ‰§è¡Œå‘½ä»¤** ä½¿ç”¨ç”Ÿæˆçš„wranglerå‘½ä»¤
4. **éªŒè¯ç»“æœ** æŸ¥è¯¢æ•°æ®åº“ç¡®è®¤æ›´æ–°

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE IF NOT EXISTS api_keys (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT UNIQUE NOT NULL,
    api_key TEXT NOT NULL,
    created_at TEXT DEFAULT (datetime('now')),
    updated_at TEXT DEFAULT (datetime('now'))
);
```

## ğŸ›¡ï¸ é‡å¤æ•°æ®å¤„ç†

è„šæœ¬ä½¿ç”¨ `INSERT OR REPLACE` è¯­æ³•å¤„ç†é‡å¤é‚®ç®±ï¼š
- å¦‚æœé‚®ç®±å·²å­˜åœ¨ï¼Œä¼šæ›´æ–°APIå¯†é’¥å’Œæ›´æ–°æ—¶é—´
- å¦‚æœé‚®ç®±ä¸å­˜åœ¨ï¼Œä¼šæ’å…¥æ–°è®°å½•

## âš ï¸ æ³¨æ„äº‹é¡¹

1. ç¡®ä¿ `wrangler.toml` ä¸­çš„æ•°æ®åº“é…ç½®æ­£ç¡®
2. é‚®ç®±åœ°å€ä½œä¸ºå”¯ä¸€é”®ï¼Œé‡å¤çš„é‚®ç®±ä¼šè¢«æ›´æ–°
3. è„šæœ¬ä¼šè‡ªåŠ¨è·³è¿‡æ ¼å¼é”™è¯¯çš„è¡Œ
4. æ”¯æŒæ³¨é‡Šè¡Œï¼ˆä»¥ `#` å¼€å¤´ï¼‰å’Œç©ºè¡Œ
5. å¦‚æœä½¿ç”¨è‡ªåŠ¨æ‰§è¡Œæ¨¡å¼ï¼Œç¡®ä¿wranglerå·²æ­£ç¡®é…ç½®

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜1: æ–‡ä»¶ä¸å­˜åœ¨
```
é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨: apikeys.txt
è§£å†³: ç¡®ä¿æ–‡ä»¶å­˜åœ¨æˆ–æŒ‡å®šæ­£ç¡®çš„æ–‡ä»¶è·¯å¾„
```

### é—®é¢˜2: wranglerå‘½ä»¤å¤±è´¥
```
é”™è¯¯: å‘½ä»¤æ‰§è¡Œå¤±è´¥
è§£å†³: æ£€æŸ¥wrangleré…ç½®å’Œæ•°æ®åº“æƒé™
```

### é—®é¢˜3: æ•°æ®æ ¼å¼é”™è¯¯
```
è­¦å‘Š: ç¬¬Xè¡Œæ ¼å¼é”™è¯¯ï¼Œè·³è¿‡
è§£å†³: ç¡®ä¿æ¯è¡Œæ ¼å¼ä¸º email:api_key
```
