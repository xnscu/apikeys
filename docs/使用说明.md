# API Keys 动态SQL生成器使用说明

## 📋 功能说明

这个脚本会**动态读取** `apikeys.txt` 文件中的数据，然后生成对应的SQL文件，最后使用wrangler命令插入到Cloudflare D1数据库。

## 🚀 使用方法

### 基础用法
```bash
# 使用默认设置（读取apikeys.txt，数据库名apikeys-pool）
python generate_sql.py

# 指定输入文件
python generate_sql.py my_apikeys.txt

# 指定输入文件和数据库名
python generate_sql.py apikeys.txt my-database

# 自动执行wrangler命令（生成SQL后直接导入数据库）
python generate_sql.py apikeys.txt apikeys-pool true
```

### 参数说明
1. **输入文件** (默认: `apikeys.txt`) - 包含API密钥的文本文件
2. **数据库名** (默认: `apikeys-pool`) - Cloudflare D1数据库名称
3. **自动执行** (默认: `false`) - 是否自动执行wrangler命令

## 📝 输入文件格式

`apikeys.txt` 文件格式：每行一条记录，格式为 `email:api_key`

```
# 这是注释行，会被忽略
user1@example.com:sk-1234567890abcdef
user2@gmail.com:sk-abcdef1234567890

# 空行也会被忽略
admin@company.com:sk-fedcba0987654321
```

## 📄 生成的文件

脚本会自动生成以下文件（带时间戳）：

1. **`schema_YYYYMMDD_HHMMSS.sql`** - 数据库表结构
2. **`insert_apikeys_YYYYMMDD_HHMMSS.sql`** - 插入数据的SQL（推荐）
3. **`upsert_apikeys_YYYYMMDD_HHMMSS.sql`** - 现代化UPSERT语法
4. **`wrangler_commands_YYYYMMDD_HHMMSS.txt`** - wrangler命令说明

## 🔧 手动执行wrangler命令

```bash
# 1. 创建表结构
wrangler d1 execute apikeys-pool --file=schema_20250924_122649.sql

# 2. 插入数据
wrangler d1 execute apikeys-pool --file=insert_apikeys_20250924_122649.sql

# 3. 验证数据
wrangler d1 execute apikeys-pool --command="SELECT COUNT(*) as total FROM api_keys;"
```

## 🎯 使用场景示例

### 场景1: 首次导入数据
```bash
python generate_sql.py
# 然后手动执行生成的wrangler命令
```

### 场景2: 自动化导入
```bash
python generate_sql.py apikeys.txt apikeys-pool true
# 脚本会自动执行所有wrangler命令
```

### 场景3: 不同的数据库
```bash
python generate_sql.py production_keys.txt prod-apikeys-db
```

### 场景4: 测试环境
```bash
python generate_sql.py test_keys.txt test-db true
```

## 🔄 数据更新流程

1. **编辑** `apikeys.txt` 文件，添加或修改API密钥
2. **运行脚本** `python generate_sql.py`
3. **执行命令** 使用生成的wrangler命令
4. **验证结果** 查询数据库确认更新

## 📊 数据库表结构

```sql
CREATE TABLE IF NOT EXISTS api_keys (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT UNIQUE NOT NULL,
    api_key TEXT NOT NULL,
    created_at TEXT DEFAULT (datetime('now')),
    updated_at TEXT DEFAULT (datetime('now'))
);
```

## 🛡️ 重复数据处理

脚本使用 `INSERT OR REPLACE` 语法处理重复邮箱：
- 如果邮箱已存在，会更新API密钥和更新时间
- 如果邮箱不存在，会插入新记录

## ⚠️ 注意事项

1. 确保 `wrangler.toml` 中的数据库配置正确
2. 邮箱地址作为唯一键，重复的邮箱会被更新
3. 脚本会自动跳过格式错误的行
4. 支持注释行（以 `#` 开头）和空行
5. 如果使用自动执行模式，确保wrangler已正确配置

## 🔍 故障排除

### 问题1: 文件不存在
```
错误: 文件不存在: apikeys.txt
解决: 确保文件存在或指定正确的文件路径
```

### 问题2: wrangler命令失败
```
错误: 命令执行失败
解决: 检查wrangler配置和数据库权限
```

### 问题3: 数据格式错误
```
警告: 第X行格式错误，跳过
解决: 确保每行格式为 email:api_key
```
